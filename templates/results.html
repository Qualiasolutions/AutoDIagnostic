{% extends "layout.html" %}

{% block title %}Diagnostic Results{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h1 class="mb-0"><i class="fas fa-clipboard-check"></i> Diagnostic Results</h1>
            </div>
            <div class="card-body">
                <!-- Vehicle Info Card -->
                <div class="card vehicle-info-card mb-4">
                    <div class="card-body">
                        <h4><i class="fas fa-car me-2"></i> Your Vehicle</h4>
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Make:</strong> {{ vehicle_info.make }}
                            </div>
                            <div class="col-md-3">
                                <strong>Model:</strong> {{ vehicle_info.model }}
                            </div>
                            <div class="col-md-3">
                                <strong>Year:</strong> {{ vehicle_info.year }}
                            </div>
                            <div class="col-md-3">
                                <strong>Mileage:</strong> {{ vehicle_info.mileage if vehicle_info.mileage else 'Not provided' }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Overall Diagnosis Status -->
                <div class="alert {% if analysis_results.overall_severity == 'critical' %}alert-danger{% elif analysis_results.overall_severity == 'high' %}alert-danger{% elif analysis_results.overall_severity == 'medium' %}alert-warning{% elif analysis_results.overall_severity == 'low' %}alert-success{% else %}alert-info{% endif %} mb-4">
                    <div class="d-flex align-items-center">
                        <div class="severity-indicator severity-{{ analysis_results.overall_severity }}"></div>
                        <h3 class="mb-0">
                            {% if analysis_results.overall_severity == 'critical' %}
                                Critical Issue Detected
                            {% elif analysis_results.overall_severity == 'high' %}
                                Significant Problem
                            {% elif analysis_results.overall_severity == 'medium' %}
                                Moderate Issue
                            {% elif analysis_results.overall_severity == 'low' %}
                                Minor Issue
                            {% else %}
                                Diagnostic Completed
                            {% endif %}
                        </h3>
                    </div>
                </div>
                
                <!-- Safety Warnings (if any) -->
                {% if analysis_results.safety_warnings and analysis_results.safety_warnings|length > 0 %}
                <div class="card mb-4">
                    <div class="card-header bg-danger text-white">
                        <h3 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i> Safety Warnings</h3>
                    </div>
                    <div class="card-body">
                        {% for warning in analysis_results.safety_warnings %}
                        <div class="safety-warning">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-exclamation-triangle safety-icon"></i>
                                <div>
                                    <strong>{{ warning.text }}</strong>
                                    <div class="text-muted mt-1">Related to: {{ warning.issue_name }}</div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Diagnosis Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3 class="mb-0"><i class="fas fa-stethoscope me-2"></i> Diagnosis</h3>
                    </div>
                    <div class="card-body">
                        {% if analysis_results.diagnosis and analysis_results.diagnosis|length > 0 %}
                            {% for diagnosis in analysis_results.diagnosis %}
                            <div class="card diagnosis-card diagnosis-{{ diagnosis.severity }} mb-3">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="severity-indicator severity-{{ diagnosis.severity }}"></div>
                                        <h4 class="mb-0">{{ diagnosis.name }}</h4>
                                    </div>
                                    <p>{{ diagnosis.description }}</p>
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <div>
                                            <span class="badge bg-{% if diagnosis.severity == 'critical' %}danger{% elif diagnosis.severity == 'high' %}danger{% elif diagnosis.severity == 'medium' %}warning{% elif diagnosis.severity == 'low' %}success{% else %}secondary{% endif %}">
                                                {{ diagnosis.severity|title }} Severity
                                            </span>
                                        </div>
                                        <div>
                                            <small class="text-muted">Confidence: 
                                                <span class="fw-bold">
                                                    {% if diagnosis.confidence >= 0.8 %}
                                                        High
                                                    {% elif diagnosis.confidence >= 0.6 %}
                                                        Medium
                                                    {% elif diagnosis.confidence > 0 %}
                                                        Low
                                                    {% else %}
                                                        Unknown
                                                    {% endif %}
                                                </span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-info">
                                No specific issues were identified. This could mean:
                                <ul class="mb-0 mt-2">
                                    <li>Your vehicle doesn't have any identifiable problems in the areas we examined</li>
                                    <li>The symptoms you described need further investigation</li>
                                    <li>You may want to try again with clearer images or more detailed descriptions</li>
                                </ul>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Repair Options Tabs -->
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="mb-0"><i class="fas fa-wrench me-2"></i> Repair Options</h3>
                            <div class="btn-group" role="group">
                                <button id="filter-all" type="button" class="btn btn-sm btn-outline-primary active" onclick="filterRepairs('all')">All</button>
                                <button id="filter-diy" type="button" class="btn btn-sm btn-outline-primary" onclick="filterRepairs('diy')">DIY</button>
                                <button id="filter-professional" type="button" class="btn btn-sm btn-outline-primary" onclick="filterRepairs('professional')">Professional</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- DIY Repairs -->
                        <div id="diy-repairs-section">
                            <h4 class="mb-3">DIY Repairs</h4>
                            
                            {% if analysis_results.diy_repairs and analysis_results.diy_repairs|length > 0 %}
                                {% for repair in analysis_results.diy_repairs %}
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h5>{{ repair.repair_name }}</h5>
                                        <p>{{ repair.description }}</p>
                                        
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <div class="difficulty-indicator">
                                                Difficulty: 
                                                {% for i in range(5) %}
                                                    <div class="difficulty-dot {% if i < repair.difficulty %}active{% endif %}"></div>
                                                {% endfor %}
                                            </div>
                                            <div>
                                                <span class="badge bg-primary">Est. Cost: {{ repair.estimated_cost }}</span>
                                            </div>
                                        </div>
                                        
                                        <button class="btn btn-primary btn-sm" onclick="toggleRepairSteps(this)" data-target="repair-steps-{{ loop.index }}">Show Steps</button>
                                        
                                        <div id="repair-steps-{{ loop.index }}" style="display: none;" class="mt-3">
                                            <h6>Repair Steps:</h6>
                                            <ol class="repair-steps">
                                                {% for step in repair.steps %}
                                                <li>{{ step }}</li>
                                                {% endfor %}
                                            </ol>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="alert alert-info">
                                    No DIY repairs are recommended for the identified issues. Professional service is advised.
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Professional Repairs -->
                        <div id="professional-repairs-section" class="mt-4">
                            <h4 class="mb-3">Professional Repairs</h4>
                            
                            {% if analysis_results.professional_repairs and analysis_results.professional_repairs|length > 0 %}
                                {% for repair in analysis_results.professional_repairs %}
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h5>{{ repair.repair_name }}</h5>
                                        <p>{{ repair.description }}</p>
                                        
                                        <div>
                                            <span class="badge bg-primary">Est. Cost: {{ repair.estimated_cost }}</span>
                                            <span class="badge bg-secondary">Professional Service</span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="alert alert-info">
                                    No professional repairs were identified for the current diagnosis.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Diagnostic Data Summary -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3 class="mb-0"><i class="fas fa-clipboard-list me-2"></i> Diagnostic Summary</h3>
                    </div>
                    <div class="card-body">
                        <!-- Visual Issues -->
                        <h5>Visual Analysis</h5>
                        {% if analysis_results.visual_issues and analysis_results.visual_issues|length > 0 %}
                            <ul class="list-group mb-4">
                                {% for issue in analysis_results.visual_issues %}
                                <li class="list-group-item 
                                    {% if issue.severity == 'high' %}list-group-item-danger
                                    {% elif issue.severity == 'medium' %}list-group-item-warning
                                    {% elif issue.severity == 'none' %}list-group-item-success
                                    {% endif %}">
                                    <strong>{{ issue.type|replace('_', ' ')|title }}:</strong> {{ issue.description }}
                                </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted">No visual issues were detected.</p>
                        {% endif %}
                        
                        <!-- Audio Symptoms -->
                        <h5>Symptom Description</h5>
                        {% if analysis_results.transcript %}
                            <div class="alert alert-secondary mb-3">
                                <strong>Your description:</strong> "{{ analysis_results.transcript }}"
                            </div>
                        {% endif %}
                        
                        {% if analysis_results.audio_symptoms and analysis_results.audio_symptoms|length > 0 %}
                            <ul class="list-group mb-4">
                                {% for symptom in analysis_results.audio_symptoms %}
                                <li class="list-group-item
                                    {% if symptom.severity == 'high' %}list-group-item-danger
                                    {% elif symptom.severity == 'medium' %}list-group-item-warning
                                    {% elif symptom.severity == 'none' %}list-group-item-success
                                    {% endif %}">
                                    <strong>{{ symptom.name|replace('_', ' ')|title }}:</strong> {{ symptom.description }}
                                </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted">No specific symptoms were identified from your description.</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="d-flex justify-content-between mt-4">
                    <form action="/diagnostic" method="get">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-redo me-2"></i> New Diagnostic
                        </button>
                    </form>
                    
                    <form action="/reset" method="post">
                        <button type="submit" class="btn btn-outline-secondary">
                            <i class="fas fa-home me-2"></i> Start Over
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
